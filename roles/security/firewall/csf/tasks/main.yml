---
- name: Check if CSF service is active
  systemd:
    name: csf.service
    state: started
  register: csf_status
  ignore_errors: true

- name: Set fact if CSF service is running
  set_fact:
    csf_installed: "{{ (csf_status is defined)
      and (not csf_status.failed | default(true))
      and (csf_status.status is defined)
      and (csf_status.status.ActiveState == 'active')
      }}"

- name: Print the result
  debug:
    msg: "CSF service installed:  {{ csf_installed }}"

- name: Download CSF archive
  get_url:
    url: "https://download.configserver.com/csf.tgz"
    dest: "/tmp/csf.tgz"
  when: not csf_installed

- name: Untar CSF archive
  unarchive:
    src: "/tmp/csf.tgz"
    dest: "/tmp/"
    remote_src: yes
  when: not csf_installed

- name: Change to CSF directory and install CSF
  command:
    cmd: "sudo bash install.sh"
    chdir: "/tmp/csf"
  when: not csf_installed
